{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Book Your Session</h3>
                </div>
                <div class="card-body">
                    <h4 class="card-title">{{ service.name }}</h4>
                    <p class="card-text">{{ service.description }}</p>
                    <hr>
                    
                    <form method="post">
                        {% csrf_token %}
                        {{ form|crispy }}
                        
                        <div class="row g-3 align-items-center mb-3">
                            <div class="col-md-8">
                                <input type="text" id="coupon-code" class="form-control" placeholder="Coupon Code">
                            </div>
                            <div class="col-md-4">
                                <button type="button" id="apply-coupon" class="btn btn-outline-primary w-100">
                                    Apply Coupon
                                </button>
                            </div>
                            <div class="col-12">
                                <p id="discount-message" class="text-success small mb-0"></p>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary">
                                Confirm Booking
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Base Price:</span>
                        <strong>${{ service.base_price }}</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Discount:</span>
                        <strong id="discount-amount">$0.00</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Total:</span>
                        <strong id="final-price">${{ service.base_price }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize date picker
    flatpickr("#id_booking_date", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        minDate: "today",
        disable: [
            function(date) {
                // Disable Sundays
                return (date.getDay() === 0);
            }
        ]
    });
    
    // Coupon code validation
    document.getElementById('apply-coupon').addEventListener('click', function() {
        const couponCode = document.getElementById('coupon-code').value;
        const serviceId = "{{ service.id }}";
        
        fetch(`/bookings/validate-coupon/?code=${couponCode}&service_id=${serviceId}`)
            .then(response => response.json())
            .then(data => {
                const discountMessage = document.getElementById('discount-message');
                const discountAmount = document.getElementById('discount-amount');
                const finalPrice = document.getElementById('final-price');
                
                if (data.valid) {
                    discountMessage.textContent = data.message;
                    discountAmount.textContent = `-$${({{ service.base_price }} - data.discounted_price).toFixed(2)}`;
                    finalPrice.textContent = `$${data.discounted_price.toFixed(2)}`;
                    // Add hidden field to form
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'coupon_code';
                    input.value = couponCode;
                    document.querySelector('form').appendChild(input);
                } else {
                    discountMessage.textContent = data.message;
                    discountAmount.textContent = '$0.00';
                    finalPrice.textContent = `$${{ service.base_price }}`;
                }
            });
    });
});
</script>
{% endblock %}